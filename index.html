<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposta de Parceria SESI - 46 Escolas</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <!-- jsPDF Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        .table-input { @apply w-24 text-center p-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-cyan-500; }
        
        /* Switch Styles */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #0891b2; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Régua Styles */
        .regua-valor-lucro { @apply w-full h-8 flex rounded-full overflow-hidden border border-gray-200 bg-gray-100 mt-2; }
        .regua-custo { @apply bg-gray-500 h-full flex items-center justify-center text-white text-xs font-bold transition-all duration-500; }
        .regua-lucro { @apply bg-green-500 h-full flex items-center justify-center text-white text-xs font-bold transition-all duration-500; }
        
        .select-input { @apply w-full text-center font-bold text-gray-800 border-b-2 border-gray-300 focus:outline-none focus:border-cyan-500 bg-white py-1; }
        .bl2-input { @apply w-full text-center text-xl font-bold text-gray-800 border-b-2 border-gray-300 focus:outline-none focus:border-cyan-500; }
        .bl2-select { @apply w-full text-center text-xl font-bold text-gray-800 border-b-2 border-gray-300 focus:outline-none focus:border-cyan-500 bg-white; }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl">

        <header class="border-b border-gray-200 pb-4 mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <img src="https://i.postimg.cc/8CXccsTc/sseducacao.png" alt="Logomarca Seduc-GO" class="h-12 md:h-16 w-auto object-contain">
            <div class="text-center md:text-right">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Proposta de Parceria</h1>
                <h2 class="text-sm md:text-lg font-semibold text-cyan-700">Atividades Complementares (Tempo Integral)</h2>
            </div>
        </header>

        <!-- BLOCO 1 -->
        <div class="mb-8">
            <h3 class="text-xl font-bold text-gray-800 border-l-4 border-cyan-600 pl-3">Bloco 1: Público-Alvo (46 Escolas)</h3>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 flex flex-col h-96">
                <div class="flex items-center gap-2 mb-2">
                    <input type="text" id="filtro-escola" placeholder="Buscar escola..." class="w-full px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-cyan-500 outline-none">
                    <button id="btn-selecionar-todas" class="px-3 py-2 bg-cyan-600 text-white text-xs rounded hover:bg-cyan-700">Todas</button>
                    <button id="btn-limpar-filtros" class="px-3 py-2 bg-gray-500 text-white text-xs rounded hover:bg-gray-600">Limpar</button>
                </div>
                <div id="lista-escolas" class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-2"></div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white border p-3 rounded text-center shadow-sm">
                        <span class="text-xs text-gray-500 block">Total Escolas</span>
                        <span id="total-escolas" class="text-2xl font-bold text-cyan-700">0</span>
                    </div>
                    <div class="bg-white border p-3 rounded text-center shadow-sm">
                        <span class="text-xs text-gray-500 block">Total Alunos (Base)</span>
                        <span id="total-alunos-base" class="text-2xl font-bold text-cyan-700">0</span>
                    </div>
                    <div class="bg-white border p-3 rounded text-center shadow-sm">
                        <span class="text-xs text-gray-500 block">Total Turmas</span>
                        <span id="total-turmas" class="text-2xl font-bold text-cyan-700">0</span>
                    </div>
                    <div class="bg-cyan-50 border p-3 rounded text-center shadow-sm">
                        <span class="text-xs text-gray-500 block">Acréscimo Especiais (%)</span>
                        <input type="number" id="acrescimo-percent" value="0" class="w-16 text-center font-bold bg-transparent border-b border-gray-400 focus:outline-none">
                    </div>
                </div>
                <div class="bg-cyan-600 text-white p-4 rounded shadow text-center">
                    <span class="text-sm block opacity-80">Total Alunos (Final Estimado)</span>
                    <span id="total-alunos-final" class="text-3xl font-bold">0</span>
                </div>
                <div id="analise-proposta" class="text-sm text-gray-600 bg-gray-50 p-3 rounded border"></div>
            </div>
        </div>

        <!-- BLOCO 2 -->
        <div class="mb-8 border-t pt-6">
            <h3 class="text-xl font-bold text-gray-800 border-l-4 border-cyan-600 pl-3 mb-4">Bloco 2: Custos Operacionais (OPEX)</h3>
            
            <!-- Parâmetros Base -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-white p-4 rounded border shadow-sm">
                    <label class="text-xs text-gray-500 block text-center">Modelo de Atendimento</label>
                    <select id="opex-modelo-atendimento" class="bl2-select text-sm">
                        <option value="288">2 dias/sem (288h)</option>
                        <option value="432">3 dias/sem (432h)</option>
                    </select>
                </div>
                <div class="bg-white p-4 rounded border shadow-sm text-center">
                    <span class="text-xs text-gray-500 block">Turmas (Base de Cálculo)</span>
                    <span id="opex-total-turmas" class="text-xl font-bold text-cyan-700">0</span>
                </div>
                <div class="bg-white p-4 rounded border shadow-sm text-center">
                    <span class="text-xs text-gray-500 block">Período (Meses)</span>
                    <span id="opex-periodo-meses" class="text-xl font-bold text-cyan-700">9</span>
                </div>
            </div>

            <!-- Custos Unitários -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4 text-center">
                <div class="bg-gray-50 p-2 rounded border">
                    <label class="text-[10px] text-gray-500 block">Bolsa Monitor</label>
                    <input type="number" id="opex-bolsa-monitor" value="1500" class="w-full bg-transparent text-center font-semibold text-sm outline-none">
                </div>
                <div class="bg-gray-50 p-2 rounded border">
                    <label class="text-[10px] text-gray-500 block">Hora Professor</label>
                    <input type="number" id="opex-valor-hora-professor" value="220" class="w-full bg-transparent text-center font-semibold text-sm outline-none">
                </div>
                <div class="bg-gray-50 p-2 rounded border">
                    <label class="text-[10px] text-gray-500 block">Salário Assistente</label>
                    <input type="number" id="opex-custo-assistente" value="5000" class="w-full bg-transparent text-center font-semibold text-sm outline-none">
                </div>
                <div class="bg-gray-50 p-2 rounded border">
                    <label class="text-[10px] text-gray-500 block">Salário Analista II</label>
                    <input type="number" id="opex-custo-analista2" value="7000" class="w-full bg-transparent text-center font-semibold text-sm outline-none">
                </div>
                <div class="bg-gray-50 p-2 rounded border">
                    <label class="text-[10px] text-gray-500 block">Salário Analista III</label>
                    <input type="number" id="opex-custo-analista3" value="9600" class="w-full bg-transparent text-center font-semibold text-sm outline-none">
                </div>
            </div>

            <!-- Totais OPEX -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded border text-center">
                    <span class="text-xs text-gray-400 block">Monitores</span>
                    <span id="opex-custo-monitores" class="font-bold text-gray-700">R$ 0,00</span>
                </div>
                <div class="bg-white p-3 rounded border text-center">
                    <span class="text-xs text-gray-400 block">Professores</span>
                    <span id="opex-custo-professores" class="font-bold text-gray-700">R$ 0,00</span>
                </div>
                <div class="bg-white p-3 rounded border text-center">
                    <span class="text-xs text-gray-400 block">Equipe Técnica</span>
                    <span id="opex-custo-equipe" class="font-bold text-gray-700">R$ 0,00</span>
                    <div class="text-[10px] text-gray-400 mt-1">
                        (<span id="opex-qtd-assistentes">0</span> Assis, <span id="opex-qtd-analistas2">0</span> An.II, <span id="opex-qtd-analistas3">0</span> An.III)
                    </div>
                </div>
                <div class="bg-cyan-600 text-white p-3 rounded text-center flex flex-col justify-center">
                    <span class="text-xs opacity-75 block">Total OPEX (Anual)</span>
                    <span id="opex-total-anual" class="text-xl font-bold">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- BLOCO 3 -->
        <div class="mb-8 border-t pt-6">
            <h3 class="text-xl font-bold text-gray-800 border-l-4 border-cyan-600 pl-3 mb-4">Bloco 3: Custos de Aquisição (CAPEX)</h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                            <th class="py-3 px-4 text-left">Item</th>
                            <th class="py-3 px-4 text-center">Qtd.</th>
                            <th class="py-3 px-4 text-left">Custo Unitário Base</th>
                            <th class="py-3 px-4 text-left">Opção de Custo</th>
                            <th class="py-3 px-4 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="capex-tabela-itens" class="text-gray-700 text-sm">
                        <!-- JS preenche -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-right">
                 <div class="inline-block bg-cyan-600 text-white p-3 rounded shadow">
                    <span class="text-xs opacity-75 block">Total CAPEX</span>
                    <span id="capex-total-geral" class="text-2xl font-bold">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- BLOCO 4 -->
        <div class="mb-8 border-t pt-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="text-xl font-bold text-gray-800 border-l-4 border-cyan-600 pl-3 mb-4">Bloco 4: Consolidação</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Condição de Pagamento</label>
                    <select id="bl4-condicao-pagamento" class="select-input">
                        <option value="mensal">Mensal (+3%)</option>
                        <option value="anual" selected>Anual (Base)</option>
                        <option value="semestral">Semestral (-2%)</option>
                        <option value="avista">À Vista (-5%)</option>
                    </select>
                    <span id="bl4-ajuste-pagamento-display" class="block text-center text-sm font-bold text-gray-500 mt-1">R$ 0,00</span>
                </div>
                <div class="flex flex-col justify-center items-end">
                    <div class="text-sm text-gray-600">OPEX: <span id="total-opex-consolidado" class="font-bold">R$ 0,00</span></div>
                    <div class="text-sm text-gray-600">CAPEX: <span id="total-capex-consolidado" class="font-bold">R$ 0,00</span></div>
                </div>
            </div>

            <div class="bg-cyan-800 text-white p-6 rounded-xl text-center shadow-lg">
                <span class="block text-sm opacity-80 uppercase tracking-wide">Valor Total da Proposta</span>
                <span id="total-geral-proposta" class="block text-4xl md:text-5xl font-bold my-2">R$ 0,00</span>
            </div>
        </div>

        <!-- BLOCO 5 (Interno) -->
        <div class="mb-8 border-t pt-6 border-red-200 bg-red-50 p-4 rounded-lg">
            <h3 class="text-lg font-bold text-red-800 mb-2">Painel de Margem (Interno)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <label class="block text-red-700 text-xs">Custo Hora Prof. (Real)</label>
                    <input type="number" id="bl5-margem-custo-hora-professor" value="150" class="w-full p-1 border rounded bg-white">
                </div>
                <div>
                    <label class="block text-red-700 text-xs">Margem CAPEX (%)</label>
                    <input type="number" id="bl5-margem-capex-percent" value="20" class="w-full p-1 border rounded bg-white">
                </div>
                <div class="text-center pt-4">
                    <span class="block text-xs text-red-700">Lucro Bruto Estimado</span>
                    <span id="bl5-margem-lucro-bruto" class="font-bold text-red-900 text-lg">R$ 0,00</span>
                </div>
            </div>
            <div class="regua-valor-lucro">
                <div id="bl5-margem-regua-custo" class="regua-custo" style="width: 0%;"></div>
                <div id="bl5-margem-regua-lucro" class="regua-lucro" style="width: 0%;"></div>
            </div>
             <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                <span>Custo</span>
                <span>Lucro</span>
            </div>
        </div>

        <div class="text-center space-x-4 pb-10">
            <button id="btn-gerar-pdf-completo" class="bg-gray-800 hover:bg-gray-900 text-white py-3 px-6 rounded shadow font-medium">PDF Completo</button>
            <button id="btn-gerar-pdf-resumo" class="bg-white hover:bg-gray-100 text-gray-800 border border-gray-400 py-3 px-6 rounded shadow font-medium">PDF Resumo</button>
        </div>

    </div>

<script>
    // --- DADOS ---
    const dadosEscolas = [
        { id: 1, nome: "EM ABRAO RASSI", alunos: 329, turmas: 12 },
        { id: 2, nome: "EM ALONSO DIAS PINHEIRO", alunos: 220, turmas: 8 },
        { id: 3, nome: "EM ANA DAS NEVES DE FREITAS", alunos: 204, turmas: 9 },
        { id: 4, nome: "EM BENEDITO SOARES DE CASTRO", alunos: 190, turmas: 7 },
        { id: 5, nome: "EM DE TEMPO INTEGRAL EUNICE WEAVER", alunos: 218, turmas: 8 },
        { id: 6, nome: "EM DE TEMPO INTEGRAL JARDIM DAS AROEIRAS", alunos: 212, turmas: 8 },
        { id: 7, nome: "EM DE TEMPO INTEGRAL JARDIM NOVO MUNDO", alunos: 266, turmas: 12 },
        { id: 8, nome: "EM DE TEMPO INTEGRAL JUSCELINO KUBITSCHEK", alunos: 169, turmas: 7 },
        { id: 9, nome: "EM DE TEMPO INTEGRAL PRESIDENTE DUTRA", alunos: 230, turmas: 8 },
        { id: 10, nome: "EM DE TEMPO INTEGRAL RUI RODRIGUES", alunos: 127, turmas: 6 },
        { id: 11, nome: "EM DE TEMPO INTEGRAL SETOR GRAJAU", alunos: 344, turmas: 12 },
        { id: 12, nome: "EM DONA BELINHA", alunos: 246, turmas: 9 },
        { id: 13, nome: "EM FRANCISCO BIBIANO DE CARVALHO", alunos: 225, turmas: 8 },
        { id: 14, nome: "EM FREI DEMETRIO ZANQUETA", alunos: 275, turmas: 10 },
        { id: 15, nome: "EM FREI NAZARENO CONFALONI", alunos: 323, turmas: 12 },
        { id: 16, nome: "EM GEORGETA RIVALINO DUARTE", alunos: 195, turmas: 7 },
        { id: 17, nome: "EM JARBAS JAYME", alunos: 199, turmas: 7 },
        { id: 18, nome: "EM JOAQUIM CÂMARA FILHO", alunos: 330, turmas: 12 },
        { id: 19, nome: "EM JOSÉ CARLOS PIMENTA", alunos: 140, turmas: 9 },
        { id: 20, nome: "EM LIONS CLUBE DE GOIÂNIA TOCANTINS", alunos: 351, turmas: 13 },
        { id: 21, nome: "EM MARECHAL RIBAS JÚNIOR", alunos: 341, turmas: 14 },
        { id: 22, nome: "EM MARIA ARAÚJO DE FREITAS", alunos: 360, turmas: 15 },
        { id: 23, nome: "EM MARIA GENOVEVA", alunos: 134, turmas: 5 },
        { id: 24, nome: "EM MOISÉS SANTANA", alunos: 166, turmas: 6 },
        { id: 25, nome: "EM MÔNICA DE CASTRO CARNEIRO", alunos: 281, turmas: 10 },
        { id: 26, nome: "EM OSTERNO POTENCIANO E SILVA", alunos: 221, turmas: 8 },
        { id: 27, nome: "EM PAULO TEIXEIRA DE MENDONCA", alunos: 177, turmas: 6 },
        { id: 28, nome: "EM PROFR MARIA CAMARGO", alunos: 242, turmas: 10 },
        { id: 29, nome: "EM PROFESSOR LOURENCO FERREIRA CAMPOS", alunos: 300, turmas: 11 },
        { id: 30, nome: "EM PROFESSORA LOUISINHA", alunos: 348, turmas: 14 },
        { id: 31, nome: "EM PROFESSORA MARIA NOSIDIA PALMEIRAS DAS NEVES", alunos: 287, turmas: 10 },
        { id: 32, nome: "EM PROFESSORA SILENE DE ANDRADE", alunos: 170, turmas: 6 },
        { id: 33, nome: "EM REGINA HELOU", alunos: 278, turmas: 10 },
        { id: 34, nome: "EM SANTA RITA DE CÁSSIA (VALE DAS POMBAS)", alunos: 103, turmas: 8 },
        { id: 35, nome: "EM SANTA TEREZINHA", alunos: 130, turmas: 7 },
        { id: 36, nome: "EM SANTO ANTÔNIO", alunos: 246, turmas: 10 },
        { id: 37, nome: "EM SEBASTIÃO ARANTES", alunos: 244, turmas: 10 },
        { id: 38, nome: "EM STEPHÂNIA ALVES BISPO", alunos: 283, turmas: 10 },
        { id: 39, nome: "EM TARGINO DE AGUIAR", alunos: 193, turmas: 7 },
        { id: 40, nome: "EM VILA ROSA", alunos: 222, turmas: 8 },
        { id: 41, nome: "EM ZEVERA ANDREA VECCI", alunos: 344, turmas: 13 },
        { id: 42, nome: "EMTI PROFESSORA MARLEI GARCIA", alunos: 414, turmas: 16 },
        { id: 43, nome: "EMTI ROTARY CLUB DE GOIANIA", alunos: 180, turmas: 8 },
        { id: 44, nome: "EMTI SANTA MARTA", alunos: 182, turmas: 9 },
        { id: 45, nome: "ESCOLA JOÃO CRISOSTOMO ROSA", alunos: 135, turmas: 5 },
        { id: 46, nome: "ESCOLA MUNICIPAL GO-04", alunos: 92, turmas: 5 }
    ];

    const dadosCapex = [
        { id: 'c1', produto: "Flauta", qtd: 112, unidade: 'escola', vlrAquisicao: 62.00 },
        { id: 'c2', produto: "Teclado", qtd: 20, unidade: 'escola', vlrAquisicao: 1200.00 },
        { id: 'c3', produto: "Violão", qtd: 20, unidade: 'escola', vlrAquisicao: 1100.00 },
        { id: 'c4', produto: "Uniforme (Balé)", qtd: 70, unidade: 'escola', vlrAquisicao: 160.00 },
        { id: 'c5', produto: "Jogos de Tabuleiro", qtd: 80, unidade: 'escola', vlrAquisicao: 180.00 },
        { id: 'c6', produto: "Bola de Voleibol", qtd: 12, unidade: 'escola', vlrAquisicao: 250.00 },
        { id: 'c7', produto: "Mesa (Tênis)", qtd: 8, unidade: 'escola', vlrAquisicao: 2500.00 },
        { id: 'c8', produto: "Kimono", qtd: 336, unidade: 'escola', vlrAquisicao: 340.00 },
        { id: 'c10', produto: "Raquete/tênis/bola/rede", qtd: 8, unidade: 'escola', vlrAquisicao: 250.00 },
        { id: 'c11', produto: "Tatame", qtd: 1, unidade: 'escola', vlrAquisicao: 10200.00 },
        { id: 'c12', produto: "Maleta Robótica I", qtd: 8, unidade: 'escola', vlrAquisicao: 2300.00 },
        { id: 'c13', produto: "Maleta Torneio", qtd: 2, unidade: 'escola', vlrAquisicao: 6200.00 },
        { id: 'c14', produto: "Maleta Robótica II", qtd: 10, unidade: 'escola', vlrAquisicao: 3900.00 },
        { id: 'c15', produto: "Carrinho de Notebook", qtd: 2, unidade: 'escola', vlrAquisicao: 8000.00 },
        { id: 'c16', produto: "Notebook", qtd: 73, unidade: 'escola', vlrAquisicao: 6200.00, locacao50: true },
        { id: 'c17', produto: "Caixa de Som", qtd: 2, unidade: 'escola', vlrAquisicao: 2000.00 },
        { id: 'c18', produto: "Kit Artes Circenses", qtd: 1, unidade: 'grupo3', vlrAquisicao: 52800.00 },
        { id: 'c19', produto: "Kit Robótica", qtd: 1, unidade: 'escola', vlrAquisicao: 39920.00 },
        { id: 'c20', produto: "Kit Dança Rítmica", qtd: 1, unidade: 'grupo3', vlrAquisicao: 62400.00 }
    ];

    // DOM
    const listaEl = document.getElementById('lista-escolas');
    const filtroEl = document.getElementById('filtro-escola');
    const acrescimoEl = document.getElementById('acrescimo-percent');
    const capexTableEl = document.getElementById('capex-tabela-itens');
    
    // Render Lista Escolas
    function renderEscolas(filter='') {
        listaEl.innerHTML = '';
        const filtered = dadosEscolas.filter(e => e.nome.toLowerCase().includes(filter.toLowerCase()));
        filtered.forEach(e => {
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 border-b hover:bg-gray-50';
            div.innerHTML = `
                <input type="checkbox" class="escola-checkbox mr-3 h-4 w-4 text-cyan-600" data-id="${e.id}" data-alunos="${e.alunos}" data-turmas="${e.turmas}">
                <div class="text-sm">
                    <div class="font-bold text-gray-700">${e.nome}</div>
                    <div class="text-xs text-gray-500">${e.alunos} Alunos | ${e.turmas} Turmas</div>
                </div>
            `;
            listaEl.appendChild(div);
        });
    }

    // Render Capex Table
    function renderCapex() {
        capexTableEl.innerHTML = '';
        dadosCapex.forEach(item => {
            const unidadeTxt = item.unidade === 'grupo3' ? '(1/3 Escolas)' : '(p/ Escola)';
            const checkedLocacao = item.locacao50 ? 'checked' : '';
            const percent = item.locacao50 ? 0.5 : 0.3;
            const labelLocacao = item.locacao50 ? 'Locação (50%)' : 'Locação (30%)';
            
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50 capex-row';
            tr.dataset.id = item.id;
            tr.innerHTML = `
                <td class="py-2 px-4 align-top"><input type="checkbox" class="capex-check" checked></td>
                <td class="py-2 px-4 align-top font-medium">${item.produto}</td>
                <td class="py-2 px-4 align-top">
                    <input type="number" class="capex-qtd w-16 border rounded text-center" value="${item.qtd}">
                    <span class="text-xs text-gray-500 ml-1">${unidadeTxt}</span>
                </td>
                <td class="py-2 px-4 align-top space-y-1">
                    <div class="flex items-center text-xs">
                        <input type="radio" name="cost_${item.id}" value="aquisicao" class="mr-1 capex-radio" checked>
                        <span class="mr-1">Aquisição:</span>
                        <input type="number" class="capex-vlr-base w-20 border rounded px-1" value="${item.vlrAquisicao}">
                    </div>
                    <div class="flex items-center text-xs text-gray-500">
                        <input type="radio" name="cost_${item.id}" value="locacao" class="mr-1 capex-radio">
                        <span>${labelLocacao}: <span class="capex-display-locacao">${(item.vlrAquisicao * percent).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></span>
                    </div>
                </td>
                <td class="py-2 px-4 text-right font-bold capex-total-item">R$ 0,00</td>
            `;
            capexTableEl.appendChild(tr);
        });
    }

    // Formatter
    const fmtBRL = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
    const parseBRL = (s) => parseFloat(s.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;

    // Main Calculation
    function calcular() {
        // Bloco 1
        const checks = document.querySelectorAll('.escola-checkbox:checked');
        let escolas = 0, alunos = 0, turmas = 0;
        checks.forEach(c => {
            escolas++;
            alunos += parseInt(c.dataset.alunos);
            turmas += parseInt(c.dataset.turmas);
        });
        const acrescimo = parseFloat(acrescimoEl.value) || 0;
        const alunosFinal = Math.round(alunos * (1 + acrescimo/100));

        document.getElementById('total-escolas').innerText = escolas;
        document.getElementById('total-alunos-base').innerText = alunos.toLocaleString('pt-BR');
        document.getElementById('total-turmas').innerText = turmas;
        document.getElementById('total-alunos-final').innerText = alunosFinal.toLocaleString('pt-BR');
        
        // Bloco 2 (OPEX)
        const periodo = 9;
        const modeloHoras = parseFloat(document.getElementById('opex-modelo-atendimento').value);
        const bolsa = parseFloat(document.getElementById('opex-bolsa-monitor').value);
        const horaProf = parseFloat(document.getElementById('opex-valor-hora-professor').value);
        const salAssist = parseFloat(document.getElementById('opex-custo-assistente').value);
        const salAnal2 = parseFloat(document.getElementById('opex-custo-analista2').value);
        const salAnal3 = parseFloat(document.getElementById('opex-custo-analista3').value);

        const qtdAssist = Math.ceil(escolas / 5);
        const qtdAnal2 = Math.ceil(escolas / 5);
        const qtdAnal3 = escolas > 0 ? 2 : 0;

        document.getElementById('opex-total-turmas').innerText = turmas;
        document.getElementById('opex-qtd-assistentes').innerText = qtdAssist;
        document.getElementById('opex-qtd-analistas2').innerText = qtdAnal2;
        document.getElementById('opex-qtd-analistas3').innerText = qtdAnal3;

        const custMon = turmas * bolsa * periodo;
        const custProf = turmas * modeloHoras * horaProf;
        const custEquipe = ((qtdAssist * salAssist) + (qtdAnal2 * salAnal2) + (qtdAnal3 * salAnal3)) * periodo;
        const totalOpex = custMon + custProf + custEquipe;

        document.getElementById('opex-custo-monitores').innerText = fmtBRL(custMon);
        document.getElementById('opex-custo-professores').innerText = fmtBRL(custProf);
        document.getElementById('opex-custo-equipe').innerText = fmtBRL(custEquipe);
        document.getElementById('opex-total-anual').innerText = fmtBRL(totalOpex);
        document.getElementById('total-opex-consolidado').innerText = fmtBRL(totalOpex);

        // Bloco 3 (CAPEX)
        let totalCapex = 0;
        document.querySelectorAll('.capex-row').forEach(row => {
            if(!row.querySelector('.capex-check').checked) {
                row.querySelector('.capex-total-item').innerText = fmtBRL(0);
                return;
            }
            const itemData = dadosCapex.find(d => d.id === row.dataset.id);
            const qtd = parseFloat(row.querySelector('.capex-qtd').value) || 0;
            const vlrBase = parseFloat(row.querySelector('.capex-vlr-base').value) || 0;
            const radioVal = row.querySelector('input[type=radio]:checked').value;
            
            // Atualiza display locação
            const percent = itemData.locacao50 ? 0.5 : 0.3;
            row.querySelector('.capex-display-locacao').innerText = fmtBRL(vlrBase * percent);

            const vlrFinal = radioVal === 'aquisicao' ? vlrBase : (vlrBase * percent);
            
            // Multiplicador
            let mult = escolas;
            if(itemData.unidade === 'grupo3') mult = Math.ceil(escolas / 3);
            // Se fosse 'turma', seria mult = turmas. Mas a base atual é escola ou grupo.

            const totalItem = qtd * vlrFinal * mult;
            totalCapex += totalItem;
            row.querySelector('.capex-total-item').innerText = fmtBRL(totalItem);
        });
        document.getElementById('capex-total-geral').innerText = fmtBRL(totalCapex);
        document.getElementById('total-capex-consolidado').innerText = fmtBRL(totalCapex);

        // Bloco 4
        const condPgto = document.getElementById('bl4-condicao-pagamento').value;
        let adjustPct = 0;
        if(condPgto === 'mensal') adjustPct = 0.03;
        if(condPgto === 'semestral') adjustPct = -0.02;
        if(condPgto === 'avista') adjustPct = -0.05;

        const subTotal = totalOpex + totalCapex;
        const valAjuste = subTotal * adjustPct;
        const totalGeral = subTotal + valAjuste;

        document.getElementById('bl4-ajuste-pagamento-display').innerText = (valAjuste >=0 ? '+' : '') + fmtBRL(valAjuste);
        document.getElementById('total-geral-proposta').innerText = fmtBRL(totalGeral);

        // Bloco 5 (Interno)
        const horaReal = parseFloat(document.getElementById('bl5-margem-custo-hora-professor').value) || 0;
        const margemCapex = parseFloat(document.getElementById('bl5-margem-capex-percent').value) || 0;
        
        // Custo Real
        const opexReal = (turmas * modeloHoras * horaReal) + custMon + custEquipe; // Monitores e equipe s/ margem no cálculo simples
        const capexReal = totalCapex / (1 + margemCapex/100);
        const custoTotalReal = opexReal + capexReal;
        const lucro = totalGeral - custoTotalReal;

        document.getElementById('bl5-margem-lucro-bruto').innerText = fmtBRL(lucro);
        
        const pctCusto = (custoTotalReal / totalGeral) * 100;
        const pctLucro = (lucro / totalGeral) * 100;
        
        document.getElementById('bl5-margem-regua-custo').style.width = `${Math.max(0, Math.min(100, pctCusto))}%`;
        document.getElementById('bl5-margem-regua-custo').innerText = pctCusto > 10 ? pctCusto.toFixed(0)+'%' : '';
        
        document.getElementById('bl5-margem-regua-lucro').style.width = `${Math.max(0, Math.min(100, pctLucro))}%`;
        document.getElementById('bl5-margem-regua-lucro').innerText = pctLucro > 10 ? pctLucro.toFixed(0)+'%' : '';
    }

    // Listeners
    filtroEl.addEventListener('input', (e) => renderEscolas(e.target.value));
    
    document.getElementById('btn-selecionar-todas').onclick = () => {
        document.querySelectorAll('.escola-checkbox').forEach(c => c.checked = true);
        calcular();
    };
    document.getElementById('btn-limpar-filtros').onclick = () => {
        document.querySelectorAll('.escola-checkbox').forEach(c => c.checked = false);
        calcular();
    };
    listaEl.addEventListener('change', calcular);
    acrescimoEl.addEventListener('input', calcular);
    
    // Opex listeners
    ['opex-modelo-atendimento', 'opex-bolsa-monitor', 'opex-valor-hora-professor', 
     'opex-custo-assistente', 'opex-custo-analista2', 'opex-custo-analista3']
     .forEach(id => document.getElementById(id).addEventListener('input', calcular));

    // Capex listeners (delegation)
    capexTableEl.addEventListener('input', calcular);
    capexTableEl.addEventListener('change', calcular);

    // Bloco 4/5 listeners
    document.getElementById('bl4-condicao-pagamento').addEventListener('change', calcular);
    document.getElementById('bl5-margem-custo-hora-professor').addEventListener('input', calcular);
    document.getElementById('bl5-margem-capex-percent').addEventListener('input', calcular);

    // PDF
    document.getElementById('btn-gerar-pdf-completo').onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = new Date().toLocaleDateString('pt-BR');
        
        doc.setFontSize(18);
        doc.text("Proposta de Parceria - Atividades Complementares", 105, 20, {align:'center'});
        
        // Tabela Resumo
        doc.autoTable({
            startY: 30,
            head: [['Conceito', 'Valor']],
            body: [
                ['Total Escolas', document.getElementById('total-escolas').innerText],
                ['Total Alunos', document.getElementById('total-alunos-final').innerText],
                ['Total OPEX', document.getElementById('total-opex-consolidado').innerText],
                ['Total CAPEX', document.getElementById('total-capex-consolidado').innerText],
                ['TOTAL GERAL', document.getElementById('total-geral-proposta').innerText]
            ]
        });
        
        // Tabela Capex Detalhada
        const capexRows = [];
        document.querySelectorAll('.capex-row').forEach(row => {
            if(row.querySelector('.capex-check').checked) {
                const tds = row.querySelectorAll('td');
                capexRows.push([
                    tds[1].innerText, // Produto
                    row.querySelector('.capex-qtd').value, // Qtd
                    row.querySelector('input[type=radio]:checked').value === 'aquisicao' ? 'Aquisição' : 'Locação',
                    row.querySelector('.capex-total-item').innerText // Total
                ]);
            }
        });
        
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['Produto', 'Qtd', 'Tipo', 'Total']],
            body: capexRows
        });
        
        doc.save('Proposta_Completa.pdf');
    };

    document.getElementById('btn-gerar-pdf-resumo').onclick = () => {
        // Mesma lógica simplificada
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Resumo da Proposta", 105, 20, {align:'center'});
        doc.autoTable({
            startY: 30,
            head: [['Item', 'Valor']],
            body: [
                ['Escolas', document.getElementById('total-escolas').innerText],
                ['Total Anual', document.getElementById('total-geral-proposta').innerText]
            ]
        });
        doc.save('Resumo.pdf');
    };

    // Init
    renderEscolas();
    renderCapex();
    calcular();

</script>
</body>
</html>
